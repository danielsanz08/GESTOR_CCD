{% extends 'navbar.html' %}
{% load static %}
{% block titulo %}Crear producto{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{% static 'css/crear_articulo.css' %}?v={% now 'U' %}">

<div class="formulario">
    <h2>Crear producto</h2>
    <form method="POST" id="form_articulo" novalidate>
        {% csrf_token %}
        <div>
            <label for="id_nombre">Nombre del producto</label>
            <input type="text" name="nombre" id="id_nombre" required autocomplete="off" placeholder="Digite el nombre del producto">
            <div class="error-msg error-nombre"></div>
        </div>

        <div>
            <label for="unidad_medida">Unidad de medida</label>
            <select name="unidad_medida" id="unidad_medida" class="form-select">
                <option value="" disabled selected>Seleccione una opción</option>
                <option value="Kilogramos">Kilogramos</option>
                <option value="Gramos">Gramos</option>
                <option value="Litros">Litros</option>
                <option value="Mililitros">Mililitros</option>
                <option value="Onzas">Onzas</option>
                <option value="Unidad">Unidad</option>
            </select>
            <div class="error-msg error-tipo"></div>
        </div>

        <div>
            <label for="id_marca">Marca del producto</label>
            <input type="text" name="marca" id="id_marca" required autocomplete="off" placeholder="Digite la marca del producto">
            <div class="error-msg error-marca"></div>
        </div>

        <div>
            <label for="id_precio">Precio</label>
            <input type="text" name="precio" id="id_precio" placeholder="Digite el precio del producto">
            <div class="error-msg error-precio"></div>
        </div>

        <div>
            <label for="id_cantidad">Cantidad</label>
            <input type="number" id="id_cantidad" min="0" step="1" name="cantidad" placeholder="Digite la cantidad">
            <div class="error-msg error-cantidad"></div>
        </div>

        <div>
            <label for="id_proveedor">Proveedor</label>
            <input type="text" id="id_proveedor" name="proveedor" placeholder="Digite el proveedor">
            <div class="error-msg error-proveedor"></div>
        </div>

        <div>
            <label for="id_presentacion">Presentación</label>
            <input type="text" name="presentacion" id="id_presentacion" placeholder="Digite la presentación">
            <div class="error-msg error-presentacion"></div>
        </div>

        <button type="submit" id="submit_btn">Registrar</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const campos = {
            nombre: document.getElementById("id_nombre"),
            tipo: document.getElementById("unidad_medida"),
            marca: document.getElementById("id_marca"),
            precio: document.getElementById("id_precio"),
            cantidad: document.getElementById("id_cantidad"),
            proveedor: document.getElementById("id_proveedor"),
            presentacion: document.getElementById("id_presentacion")
        };

        const errores = {
            nombre: document.querySelector(".error-nombre"),
            tipo: document.querySelector(".error-tipo"),
            marca: document.querySelector(".error-marca"),
            precio: document.querySelector(".error-precio"),
            cantidad: document.querySelector(".error-cantidad"),
            proveedor: document.querySelector(".error-proveedor"),
            presentacion: document.querySelector(".error-presentacion")
        };

        function tieneTresOMasRepetidos(valor) {
            // Detecta 3 o más caracteres idénticos consecutivos
            return /(.)\1{2,}/.test(valor);
        }

        function validarTexto(valor) {
            if (valor.trim().length > 0 && valor.length < 3) return "Mínimo 3 caracteres";
            if (!/^[a-zA-ZÁÉÍÓÚáéíóúñÑ\s.,;:¡!¿?\"'()\/\-]*$/.test(valor)) return "Solo caracteres válidos";
            if (tieneTresOMasRepetidos(valor)) return "Máximo 2 caracteres repetidos (ej: 'ff' sí, 'fff' no)";
            return "";
        }

        function validarCantidad(valor) {
            if (!/^\d+$/.test(valor) || parseInt(valor) < 0) return "Número entero positivo";
            return "";
        }

        function validarPrecio(valor) {
            valor = valor.replace(/,/g, "");
            if (!/^\d+(\.\d{0,2})?$/.test(valor) || parseFloat(valor) < 0) return "Formato inválido";
            return "";
        }

        function validarPresentacion(valor) {
            if (valor.length > 30) return "Máximo 30 caracteres";
            return validarTexto(valor);
        }

        function mostrarError(campo, mensaje) {
            errores[campo].textContent = mensaje;
        }

        function formatearPrecio(valor) {
            return valor.replace(/,/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function capitalizar(valor) {
            return valor.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
        }

        // Configuración de eventos
        campos.nombre.addEventListener("input", function() {
            this.value = capitalizar(this.value.replace(/[0-9]/g, ""));
            mostrarError("nombre", validarTexto(this.value));
        });

        campos.marca.addEventListener("input", function() {
            this.value = capitalizar(this.value.replace(/[0-9]/g, ""));
            mostrarError("marca", validarTexto(this.value));
        });

        campos.proveedor.addEventListener("input", function() {
            this.value = capitalizar(this.value.replace(/[0-9]/g, ""));
            mostrarError("proveedor", validarTexto(this.value));
        });

        campos.presentacion.addEventListener("input", function() {
            this.value = capitalizar(this.value.replace(/[0-9]/g, ""));
            mostrarError("presentacion", validarPresentacion(this.value));
        });

        campos.precio.addEventListener("input", function() {
            let valor = this.value.replace(/[^\d.]/g, "");
            if ((valor.match(/\./g) || []).length > 1) {
                valor = valor.substring(0, valor.lastIndexOf("."));
            }
            this.value = formatearPrecio(valor);
            mostrarError("precio", validarPrecio(valor));
        });

        campos.cantidad.addEventListener("input", function() {
            mostrarError("cantidad", validarCantidad(this.value));
        });

        campos.tipo.addEventListener("change", function() {
            mostrarError("tipo", this.value ? "" : "Seleccione una opción");
        });

        document.getElementById("form_articulo").addEventListener("submit", function(e) {
            let esValido = true;
            
            // Validar todos los campos
            if (validarTexto(campos.nombre.value)) {
                mostrarError("nombre", validarTexto(campos.nombre.value));
                esValido = false;
            }
            
            if (!campos.tipo.value) {
                mostrarError("tipo", "Seleccione una unidad");
                esValido = false;
            }
            
            if (validarTexto(campos.marca.value)) {
                mostrarError("marca", validarTexto(campos.marca.value));
                esValido = false;
            }
            
            if (validarPrecio(campos.precio.value.replace(/,/g, ""))) {
                mostrarError("precio", validarPrecio(campos.precio.value.replace(/,/g, "")));
                esValido = false;
            }
            
            if (validarCantidad(campos.cantidad.value)) {
                mostrarError("cantidad", validarCantidad(campos.cantidad.value));
                esValido = false;
            }
            
            if (validarTexto(campos.proveedor.value)) {
                mostrarError("proveedor", validarTexto(campos.proveedor.value));
                esValido = false;
            }
            
            if (validarPresentacion(campos.presentacion.value)) {
                mostrarError("presentacion", validarPresentacion(campos.presentacion.value));
                esValido = false;
            }
            
            if (!esValido) e.preventDefault();
        });
    });
</script>
{% endblock %}