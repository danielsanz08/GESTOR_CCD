{% extends 'navbar.html' %}
{% load static %}

{% block titulo %}Lista de usuarios{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{% static 'css/lista_usuarios.css' %}?v={% now 'U' %}">

<style>
    
    /* Modal personalizado */
    .modal-custom {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }
    .modal-content-custom {
        background: white;
        padding: 20px;
        border-radius: 5px;
        width: 320px;
        max-width: 90%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        position: relative;
    }
    .modal-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .modal-header-custom h5 {
        margin: 0;
        font-size: 18px;
    }
    .btn-close-custom {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        line-height: 1;
    }

    /* Permisos */
    .permiso-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .permiso-label {
        margin-left: 10px;
        cursor: pointer;
    }

    /* Footer modal */
    .modal-footer-custom {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .btn-cancelar, .btn-guardar {
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 4px;
        border: none;
        font-size: 14px;
    }
    .btn-cancelar {
        background-color: #6c757d;
        color: white;
    }
    .btn-cancelar:hover {
        background-color: #5a6268;
    }
    .btn-guardar {
        background-color: #0d6efd;
        color: white;
    }
    .btn-guardar:hover {
        background-color: #0b5ed7;
    }
</style>

<section>
    <h1>Usuarios de PapelerÃ­a</h1>
    
    <table>
        <thead>
            <tr>
                <th class="id">ID</th>
                <th class="nombre">Nombre</th>
                <th class="rol">Rol</th>
                <th class="correo">Correo</th>
                <th class="area">Area</th>
                <th class="cargo">Cargo</th>
                <th class="estado">Estado</th>
                <th class="actividad">Actividad</th>
                <th class="editar">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
            <tr>
                <td>{{ usuario.id }}</td>
                <td>{{ usuario.username }}</td>
                <td>{{ usuario.role }}</td>
                <td>{{ usuario.email }}</td>
                <td>{{ usuario.area }}</td>
                <td>{{ usuario.cargo }}</td>
                <td class="td_estado">{% if usuario.is_active %}Activo{% else %}Inactivo{% endif %}</td>
                <td class="td_btn_estado">
                    <form action="{% url 'libreria:cambiar_estado_usuario' usuario.id %}" method="POST">
                        {% csrf_token %}
                        <label class="cl-switch">
                            <input type="checkbox" name="is_active" {% if usuario.is_active %}checked{% endif %}
                                onchange="this.form.submit()">
                            <span></span>
                        </label>
                    </form>
                </td>
                <td class="td_editar">
                    <a href="{% url 'libreria:editar_usuario' usuario.id %}">
                        <button class="editar-btn" title="Editar usuario">
                            âœŽ
                        </button>
                    </a>
                    <button class="permisos-btn" title="Gestionar permisos" onclick="abrirModal({{ usuario.id }})">
                        ðŸ”‘
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9">No se encontraron usuarios.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Modales para permisos -->
    {% for usuario in usuarios %}
    <div id="modal{{ usuario.id }}" class="modal-custom" onclick="cerrarModal({{ usuario.id }})">
        <div class="modal-content-custom" onclick="event.stopPropagation()">
            <div class="modal-header-custom">
                <h5>Permisos de {{ usuario.username }}</h5>
                <button onclick="cerrarModal({{ usuario.id }})" class="btn-close-custom">&times;</button>
            </div>
            <form method="POST" action="{% url 'libreria:lista_usuarios' %}">
                {% csrf_token %}
                <input type="hidden" name="actualizar_permisos" value="1">
                <input type="hidden" name="usuario_id" value="{{ usuario.id }}">
                <div class="modal-body-custom">
                    <div class="permiso-item">
                        <input type="checkbox" id="pap{{ usuario.id }}" name="acceso_pap" 
                               {% if usuario.acceso_pap %}checked{% endif %} 
                               class="form-check-input">
                        <label for="pap{{ usuario.id }}" class="permiso-label">Acceso a PapelerÃ­a</label>
                    </div>
                    <div class="permiso-item">
                        <input type="checkbox" id="caf{{ usuario.id }}" name="acceso_caf" 
                               {% if usuario.acceso_caf %}checked{% endif %} 
                               class="form-check-input">
                        <label for="caf{{ usuario.id }}" class="permiso-label">Acceso a CafeterÃ­a</label>
                    </div>
                    <div class="permiso-item">
                        <input type="checkbox" id="cde{{ usuario.id }}" name="acceso_cde" 
                               {% if usuario.acceso_cde %}checked{% endif %} 
                               class="form-check-input">
                        <label for="cde{{ usuario.id }}" class="permiso-label">Acceso a Centro de Eventos</label>
                    </div>
                </div>
                <div class="modal-footer-custom">
                    <button type="button" onclick="cerrarModal({{ usuario.id }})" class="btn-cancelar">Cerrar</button>
                    <button type="submit" class="btn-guardar">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
    {% endfor %}
</section>

<script>
    function abrirModal(id) {
        document.getElementById('modal' + id).style.display = 'flex';
    }
    function cerrarModal(id) {
        document.getElementById('modal' + id).style.display = 'none';
    }

    // Cerrar modal si presionas la tecla ESC
    document.addEventListener('keydown', function(event) {
        if(event.key === "Escape") {
            const modals = document.querySelectorAll('.modal-custom');
            modals.forEach(modal => modal.style.display = 'none');
        }
    });
</script>

{% endblock %}
