{% extends 'navbar.html' %}
{% load static %}
{% block titulo %}Crear artículo{% endblock %}

{% block contenido %}
<style>
    .error-msg {
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }

    .error-nombre,
    .error-tipo,
    .error-marca,
    .error-precio,
    .error-cantidad,
    .error-proveedor,
    .error-observacion {
        color: #ff0101;
        font-weight: bold;
        position: absolute;
    }

    .error-nombre { top: 27vh; left: 13vh; }
    .error-tipo { top: 27vh; left: 58vh; }
    .error-marca { top: 27vh; left: 102vh; }
    .error-precio { top: 39vh; left: 13vh; }
    .error-cantidad { top: 23.5vh; left: 58vh; }
    .error-proveedor { top: 42vh; left: 102vh; }
    .error-observacion { top: 59vh; left: 11vh; }
</style>

<link rel="stylesheet" href="{% static 'css/crear_articulo.css' %}?v={% now 'U' %}">

<div class="fondo">
    <img src="{% static 'imagen/LOGO.png' %}" alt="Logo CCD">
</div>

<div class="formulario">
    <h2>Crear artículo</h2>
    <form method="POST" id="form_articulo">
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_nombre" class="form-label">Nombre del artículo</label>
            <input type="text" name="nombre" id="id_nombre" class="form-control" required autocomplete="off" placeholder="Maximo 40 caracteres" maxlength="40" >
            <div class="error-msg error-nombre"></div>
        </div>

        <div class="mb-3">
            <label for="id_tipo" class="form-label">Digite el tipo de artículo</label>
            <input type="text" name="tipo" id="id_tipo" placeholder="Maximo 30 caracteres" value="No establecido" maxlength="30">
            <div class="error-msg error-tipo"></div>
        </div>

        <div class="mb-3">
            <label for="id_marca" class="form-label">Marca del artículo</label>
            <input type="text" name="marca" id="id_marca" class="form-control" required autocomplete="off" placeholder="Maximo 30 caracteres" maxlength="30">
            <div class="error-msg error-marca"></div>
        </div>

        <div class="mb-3">
            <label for="id_precio" class="form-label">Digite el precio</label>
            <input type="text" name="precio" id="id_precio" placeholder="Digite el precio del artículo">
            <div class="error-msg error-precio"></div>
        </div>

        <div class="mb-3">
            <label for="id_cantidad" class="form-label">Digite la cantidad</label>
            <input type="number" id="id_cantidad" min="0" step="1" name="cantidad" placeholder="Digite la cantidad del artículo" maxlength="9">
            <div class="error-msg error-cantidad"></div>
        </div>

        <div class="mb-3">
            <label for="id_proveedor" class="form-label">Digite el proveedor</label>
            <input type="text" id="id_proveedor" name="proveedor" placeholder="Maximo 40 caracteres" maxlength="40">
            <div class="error-msg error-proveedor"></div>
        </div>

        <div class="mb-3">
            <label for="id_observacion" class="form-label">Observación del artículo:</label>
            <input type="text" name="observacion" id="id_observacion" class="form-control" placeholder="Maximo 30 caracteres" maxlength="30">
            <div class="error-msg error-observacion"></div>
        </div>

        <button type="submit" class="btn" id="submit_btn">Registrar artículo</button>
    </form>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const campos = {
            nombre: document.getElementById("id_nombre"),
            tipo: document.getElementById("id_tipo"),
            marca: document.getElementById("id_marca"),
            precio: document.getElementById("id_precio"),
            cantidad: document.getElementById("id_cantidad"),
            proveedor: document.getElementById("id_proveedor"),
            observacion: document.getElementById("id_observacion"),
        };

        const errores = {
            nombre: document.querySelector(".error-nombre"),
            tipo: document.querySelector(".error-tipo"),
            marca: document.querySelector(".error-marca"),
            precio: document.querySelector(".error-precio"),
            cantidad: document.querySelector(".error-cantidad"),
            proveedor: document.querySelector(".error-proveedor"),
            observacion: document.querySelector(".error-observacion"),
        };

        function capitalizarPrimeraLetra(texto) {
            return texto.charAt(0).toUpperCase() + texto.slice(1);
        }

        function validarTexto(valor) {
            if (valor.trim().length > 0 && valor.length < 3) {
                return "Debe tener al menos 3 caracteres.";
            }
            if (!/^[a-zA-ZÁÉÍÓÚáéíóúñÑ0-9\s.,;:¡!¿?"'()\/\-]*$/.test(valor)) {
                return "Contiene caracteres inválidos.";
            }
            if (/(.)\1{2,}/.test(valor)) {
                return "No repita un mismo carácter más de 2 veces.";
            }
            return "";
        }

        function validarCantidad(valor) {
            return (!/^\d*$/.test(valor) || parseInt(valor) < 0) ? "Debe ser un número entero positivo." : "";
        }

        function validarPrecio(valor) {
            valor = valor.replace(/,/g, "");
            return (!/^\d+(\.\d{0,2})?$/.test(valor) || parseFloat(valor) < 0)
                ? "Debe ser un número positivo con hasta 2 decimales." : "";
        }

        function aplicarEventosCampoTexto(nombreCampo, validarFn) {
            const input = campos[nombreCampo];
            const errorDiv = errores[nombreCampo];

            input.addEventListener("input", function () {
                const pos = input.selectionStart;
                input.value = capitalizarPrimeraLetra(input.value);
                input.setSelectionRange(pos, pos);

                const msg = validarFn(input.value);
                errorDiv.textContent = input.value.trim() ? msg : "";
            });
        }

        function validarObservacion(valor) {
            return validarTexto(valor);
        }

        aplicarEventosCampoTexto("nombre", validarTexto);
        aplicarEventosCampoTexto("tipo", validarTexto);
        aplicarEventosCampoTexto("marca", validarTexto);
        aplicarEventosCampoTexto("proveedor", validarTexto);
        aplicarEventosCampoTexto("observacion", validarObservacion);

        campos.precio.addEventListener("input", function () {
            let valor = campos.precio.value;

            // Elimina caracteres que no sean números o un solo punto
            valor = valor.replace(/[^\d.]/g, "");

            // Permite solo un punto decimal
            const partes = valor.split(".");
            if (partes.length > 2) {
                valor = partes[0] + "." + partes.slice(1).join("");
            }

            const entero = partes[0];
            const decimal = partes[1] ? partes[1].slice(0, 2) : "";

            // Formatea el entero con comas
            const enteroConComas = entero.replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            // Resultado final
            const valorFormateado = decimal ? `${enteroConComas}.${decimal}` : enteroConComas;

            campos.precio.value = valorFormateado;
            errores.precio.textContent = validarPrecio(entero + (decimal ? "." + decimal : ""));
        });

        campos.cantidad.addEventListener("input", function () {
            errores.cantidad.textContent = validarCantidad(campos.cantidad.value);
        });

        document.getElementById("form_articulo").addEventListener("submit", function () {
            campos.precio.value = campos.precio.value.replace(/,/g, "");

            ["nombre", "tipo", "marca", "proveedor", "observacion"].forEach(campo => {
                campos[campo].value = capitalizarPrimeraLetra(campos[campo].value);
            });
        });
    });
</script>

{% endblock %}
