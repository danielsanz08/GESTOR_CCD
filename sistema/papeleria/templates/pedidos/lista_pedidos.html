{% extends 'navbar.html' %}
{% load static %}

{% block titulo %}Lista{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{% static 'css/listar_pedido.css' %}?v={% now 'U' %}">
<style>
 
 
    /* Modal */
    #modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 500px;
        width: 90%;
    }

    #modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    #modal button {
        margin-top: 15px;
        padding: 8px 12px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    #modal button:hover {
        background-color: #0056b3;
    }

    .detalles-ocultos {
        display: none;
    }

    .btn-accion {
        margin: 5px;
        padding: 6px 10px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-accion.cancelar {
        background-color: #dc3545;
    }

    .btn-accion:hover {
        opacity: 0.9;
    }
</style>

<section class="pedido">
    <h1>Listado de Pedidos</h1>

<table>
    <thead>
        <tr>
            <th class="id">ID</th>
            <th class="usuario">Registrado por</th>
            <th class="fecha">Fecha</th>
            <th class="estado">Estado</th>
            <th class="detalle">Detalles</th>
            
        </tr>
    </thead>
    <tbody>
        {% for pedido in pedidos %}
        <tr>
            <td>{{ pedido.id }}</td>
            <td>{{ pedido.registrado_por }}</td>
            <td>{{ pedido.fecha_formateada }}</p></td>
            <td>{{ pedido.get_estado_display }}</td>
            <td>
                <button type="button" onclick="mostrarDetalles('{{ pedido.id }}')"> <i data-feather="eye" class="icono"></i></button>

                <!-- Contenido oculto para el modal -->
                <div id="detalles-{{ pedido.id }}" class="detalles-ocultos">
                    <p><strong>Registrado por:</strong> {{ pedido.registrado_por }}</p>
                    <p><strong>Fecha:</strong> {{ pedido.fecha_pedido }}</p>
                    <p><strong>Estado:</strong> {{ pedido.get_estado_display }}</p>
                    <p><strong>Artículos:</strong></p>
                    <ul>
                        {% for articulo in pedido.articulos.all %}
                        <li>{{ articulo.articulo.nombre }} × {{ articulo.cantidad }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </td>
            
                {% if user.perfil.rol == 'Administrador' and pedido.estado == 'pendiente' %}
                <td><form method="POST" action="{% url 'cambiar_estado_pedido' pedido.id %}">
                    {% csrf_token %}
                    <button type="submit" name="estado" value="confirmado" class="btn-accion">Confirmar</button>
                    <button type="submit" name="estado" value="cancelado" class="btn-accion cancelar">Cancelar</button>
                </form>
                {% else %}
                    
                {% endif %}</td>
                
            
        </tr>
        {% empty %}
        <tr>
            <td colspan="6">No hay pedidos registrados.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</section>

<!-- Modal -->
<div id="modal">
    <div id="modal-content"></div>
    <button onclick="cerrarModal()">Cerrar</button>
</div>

<!-- Fondo oscuro detrás del modal -->
<div id="modal-backdrop" onclick="cerrarModal()"></div>

<script>
    function mostrarDetalles(id) {
        var contenido = document.getElementById("detalles-" + id).innerHTML;
        document.getElementById("modal-content").innerHTML = contenido;
        document.getElementById("modal").style.display = "block";
        document.getElementById("modal-backdrop").style.display = "block";
    }

    function cerrarModal() {
        document.getElementById("modal").style.display = "none";
        document.getElementById("modal-backdrop").style.display = "none";
    }
</script>
{% endblock %}
